MACRO(MD5SUM expected filename)
  EXECUTE_PROCESS(COMMAND ${CMAKE_COMMAND} -E md5sum ${filename}
    OUTPUT_VARIABLE md5)
  IF (NOT md5 MATCHES ${expected})
    MESSAGE(FATAL_ERROR "unexpected md5sum: " ${md5})
  ENDIF()
ENDMACRO()
MACRO(EXECUTE_PROGRAM)
  EXECUTE_PROCESS(COMMAND ${ARGV} RESULT_VARIABLE res)
  IF (res)
    MESSAGE(FATAL_ERROR "${ARGV} failed: " ${res})
  ENDIF()
ENDMACRO()
MACRO(CBMCONVERT)
  EXECUTE_PROGRAM(${CBMCONVERT} ${ARGV})
ENDMACRO()

FILE(REMOVE 1.prg 2.prg 3.prg 1.p00 2.p00 3.p00 123.lnx 123.d64)
FILE(WRITE 1.prg "1")
FILE(WRITE 2.prg "12")
FILE(WRITE 3.prg "123")
CBMCONVERT(-D4 123.d64 1.prg 2.prg 3.prg)
MD5SUM(75816bb6b5f90c12db2979a42fbdf987 123.d64)
CBMCONVERT(-L 123.lnx -d 123.d64)
MD5SUM(fc71016e5bcd397d0b88e0d498f2a133 123.lnx)
FILE(REMOVE 123.lnx 123.d64)
CBMCONVERT(-L 123.lnx 1.prg 2.prg 3.prg)
MD5SUM(fc71016e5bcd397d0b88e0d498f2a133 123.lnx)
CBMCONVERT(-D4 123.d64 -l 123.lnx)
MD5SUM(75816bb6b5f90c12db2979a42fbdf987 123.d64)

CBMCONVERT(-P -l 123.lnx)
MD5SUM(ca80b5d5492283789cb53c1868783b83 1.p00)
MD5SUM(2abfea98086627c448530dae6f19970f 2.p00)
MD5SUM(ac1246d517a9d6db969185fe60746900 3.p00)

FOREACH(i RANGE 1 254)
  LIST(APPEND b ${i})
ENDFOREACH()
LIST(REMOVE_ITEM b 59)
STRING(ASCII ${b} b)
FILE(WRITE 4.prg "${b};")
FILE(WRITE 5.prg "${b}:")
CBMCONVERT(-D4 123.d64 4.prg 5.prg)
EXECUTE_PROGRAM(${DISK2ZIP} 123.d64 123)
MD5SUM(0c66b6561fb968faeb751eb94a68098b 1!123)
MD5SUM(ef4bae7508940492d5452b4f13965cab 2!123)
MD5SUM(5437f3359698a251124d4b787bf19c7b 3!123)
MD5SUM(0cae9f355cf09bc153272c4b8d2b97cd 4!123)
EXECUTE_PROGRAM(${ZIP2DISK} 123 4.d64)
EXECUTE_PROGRAM(${CMAKE_COMMAND} -E compare_files 123.d64 4.d64)
FILE(REMOVE 1!123 2!123 3!123 4!123 4.d64 4.prg 5.prg)

FILE(REMOVE 1.prg 2.prg 3.prg 1.p00 2.p00 3.p00 123.lnx 123.d64)
